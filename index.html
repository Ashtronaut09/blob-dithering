<!DOCTYPE html>
<meta charset="utf-8" />
<body
  style="position: fixed; left: 0px; right: 0px; top: 0px; bottom: 0px; overflow: hidden; margin: 0; padding: 0; background: #000;"
>
  <canvas
    id="canvas"
    style="width: 100%; height: 100%; padding: 0;margin: 0;"
  ></canvas>

  <!-- Control Panel -->
  <div id="controls" style="
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0,0,0,0.85);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 16px;
    font-family: -apple-system, sans-serif;
    font-size: 12px;
    color: #fff;
    min-width: 200px;
    z-index: 100;
    max-height: 90vh;
    overflow-y: auto;
  ">
    <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">Controls</div>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Gamma (darkness) <span id="gammaVal">3.0</span>
      </span>
      <input type="range" id="gamma" min="0.5" max="6" step="0.1" value="3" style="width: 100%; margin-top: 4px;">
    </label>

    <div style="font-weight: 500; margin: 16px 0 8px; font-size: 11px; color: #888; text-transform: uppercase;">Cloud</div>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Drift speed <span id="speedVal">0.08</span>
      </span>
      <input type="range" id="speed" min="0" max="0.5" step="0.01" value="0.08" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Direction <span id="directionVal">45°</span>
      </span>
      <input type="range" id="direction" min="0" max="360" step="5" value="45" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Cloud scale <span id="cloudScaleVal">1.0</span>
      </span>
      <input type="range" id="cloudScale" min="0.3" max="3" step="0.1" value="1" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Cloud density <span id="cloudDensityVal">0.50</span>
      </span>
      <input type="range" id="cloudDensity" min="0.1" max="1" step="0.05" value="0.5" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Evolution <span id="evolveVal">0.100</span>
      </span>
      <input type="range" id="evolve" min="0" max="0.2" step="0.005" value="0.1" style="width: 100%; margin-top: 4px;">
    </label>

    <div style="font-weight: 500; margin: 16px 0 8px; font-size: 11px; color: #888; text-transform: uppercase;">Color</div>

    <label style="display: block; margin-bottom: 12px;">
      <input type="checkbox" id="useColor" style="margin-right: 8px;" checked>
      Use gradient colors
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Gradient angle <span id="gradientAngleVal">263°</span>
      </span>
      <input type="range" id="gradientAngle" min="0" max="360" step="5" value="263" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Color shift <span id="colorShiftVal">0.00</span>
      </span>
      <input type="range" id="colorShift" min="0" max="1" step="0.01" value="0" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Saturation <span id="saturationVal">1.0</span>
      </span>
      <input type="range" id="saturation" min="0" max="2" step="0.1" value="1" style="width: 100%; margin-top: 4px;">
    </label>

    <div style="font-weight: 500; margin: 16px 0 8px; font-size: 11px; color: #888; text-transform: uppercase;">Dither</div>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Dither scale <span id="ditherScaleVal">0.20</span>
      </span>
      <input type="range" id="ditherScale" min="0.1" max="2" step="0.05" value="0.2" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Contrast <span id="contrastVal">1.0</span>
      </span>
      <input type="range" id="contrast" min="0.5" max="2" step="0.1" value="1" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Grey levels <span id="greyLevelsVal">2</span>
      </span>
      <input type="range" id="greyLevels" min="2" max="8" step="1" value="2" style="width: 100%; margin-top: 4px;">
    </label>

    <div style="font-weight: 500; margin: 16px 0 8px; font-size: 11px; color: #888; text-transform: uppercase;">Mouse</div>

    <label style="display: block; margin-bottom: 12px;">
      <input type="checkbox" id="mouseEnabled" style="margin-right: 8px;" checked>
      Enable mouse effect
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Radius <span id="mouseRadiusVal">150</span>
      </span>
      <input type="range" id="mouseRadius" min="20" max="300" step="5" value="150" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Softness <span id="mouseSoftnessVal">0.5</span>
      </span>
      <input type="range" id="mouseSoftness" min="0" max="1" step="0.05" value="0.5" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Strength <span id="mouseStrengthVal">1.0</span>
      </span>
      <input type="range" id="mouseStrength" min="0" max="1" step="0.05" value="1" style="width: 100%; margin-top: 4px;">
    </label>

    <label style="display: block; margin-bottom: 12px;">
      <span style="display: flex; justify-content: space-between;">
        Easing <span id="mouseEasingVal">0.08</span>
      </span>
      <input type="range" id="mouseEasing" min="0.01" max="1" step="0.01" value="0.08" style="width: 100%; margin-top: 4px;">
    </label>

    <div style="display: flex; gap: 8px; margin-top: 12px;">
      <button id="saveDefaults" style="
        flex: 1;
        padding: 8px;
        background: #2a5a2a;
        border: none;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
      ">Save Defaults</button>
      <button id="resetDefaults" style="
        flex: 1;
        padding: 8px;
        background: #5a2a2a;
        border: none;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
      ">Reset</button>
    </div>

    <button id="togglePanel" style="
      width: 100%;
      padding: 8px;
      background: #333;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      margin-top: 8px;
    ">Hide Panel (H)</button>
  </div>

  <!-- Profiles Panel -->
  <div id="profilesPanel" style="
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0,0,0,0.85);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 16px;
    font-family: -apple-system, sans-serif;
    font-size: 12px;
    color: #fff;
    min-width: 200px;
    z-index: 100;
  ">
    <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">Profiles</div>

    <div style="margin-bottom: 8px;">
      <select id="profileSelect" style="
        width: 100%;
        padding: 8px;
        background: #222;
        border: 1px solid #444;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
      ">
        <option value="">-- Select Profile --</option>
      </select>
    </div>

    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
      <input type="text" id="profileName" placeholder="Profile name" style="
        flex: 1;
        padding: 8px;
        background: #222;
        border: 1px solid #444;
        border-radius: 4px;
        color: #fff;
      ">
    </div>

    <button id="saveProfile" style="
      width: 100%;
      padding: 8px;
      background: #2a5a2a;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      margin-bottom: 8px;
    ">Save Profile</button>

    <button id="deleteProfile" style="
      width: 100%;
      padding: 8px;
      background: #5a2a2a;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    ">Delete Selected</button>

    <button id="toggleProfilesPanel" style="
      width: 100%;
      padding: 8px;
      background: #333;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      margin-top: 8px;
    ">Hide (P)</button>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // Gradient colors from CSS
    // Pink/Magenta to Yellow/Gold
    // Purple to Cyan
    const gradientColors = [
      { r: 237, g: 82, b: 142 },   // Pink/Magenta
      { r: 246, g: 201, b: 98 },   // Yellow/Gold
      { r: 106, g: 71, b: 205 },   // Purple
      { r: 105, g: 216, b: 239 }   // Cyan
    ];

    // Default settings
    const defaultSettings = {
      gamma: 3,
      speed: 0.08,
      ditherScale: 0.2,
      cloudDensity: 0.5,
      contrast: 1,
      direction: 45,
      cloudScale: 1,
      evolve: 0.1,
      greyLevels: 2,
      gradientAngle: 263,
      colorShift: 0,
      saturation: 1,
      useColor: true,
      mouseEnabled: true,
      mouseRadius: 150,
      mouseSoftness: 0.5,
      mouseStrength: 1.0,
      mouseEasing: 0.08
    };

    // Load saved defaults or use defaults
    const loadSettings = () => {
      const saved = localStorage.getItem('cloudDitherGradientSettings');
      if (saved) {
        try {
          return { ...defaultSettings, ...JSON.parse(saved) };
        } catch (e) {
          return { ...defaultSettings };
        }
      }
      return { ...defaultSettings };
    };

    const settings = loadSettings();

    // Profile management
    const loadProfiles = () => {
      const saved = localStorage.getItem('cloudDitherProfiles');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          return {};
        }
      }
      return {};
    };

    const saveProfiles = (profiles) => {
      localStorage.setItem('cloudDitherProfiles', JSON.stringify(profiles));
    };

    let profiles = loadProfiles();

    const updateProfileSelect = () => {
      const select = document.getElementById('profileSelect');
      select.innerHTML = '<option value="">-- Select Profile --</option>';
      Object.keys(profiles).sort().forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
    };

    // Mouse position with easing
    let mouseX = -1000, mouseY = -1000;
    let targetMouseX = -1000, targetMouseY = -1000;
    let mouseInitialized = false;

    canvas.addEventListener("mousemove", e => {
      const rect = canvas.getBoundingClientRect();
      targetMouseX = (e.clientX - rect.left) / rect.width * imgSize;
      targetMouseY = (e.clientY - rect.top) / rect.height * imgSize;

      // Jump to position immediately on first move
      if (!mouseInitialized) {
        mouseX = targetMouseX;
        mouseY = targetMouseY;
        mouseInitialized = true;
      }
    });
    canvas.addEventListener("mouseleave", () => {
      targetMouseX = -1000;
      targetMouseY = -1000;
      mouseX = -1000;
      mouseY = -1000;
      mouseInitialized = false;
    });

    const updateMousePosition = () => {
      if (mouseInitialized) {
        mouseX += (targetMouseX - mouseX) * settings.mouseEasing;
        mouseY += (targetMouseY - mouseY) * settings.mouseEasing;
      }
    };

    // UI elements
    const controlsPanel = document.getElementById("controls");
    const toggleBtn = document.getElementById("togglePanel");

    const bindSlider = (id, key, valId, formatter = v => v.toFixed(1)) => {
      const slider = document.getElementById(id);
      slider.oninput = () => {
        settings[key] = parseFloat(slider.value);
        document.getElementById(valId).textContent = formatter(settings[key]);
      };
    };

    bindSlider("gamma", "gamma", "gammaVal");
    bindSlider("speed", "speed", "speedVal", v => v.toFixed(2));
    bindSlider("direction", "direction", "directionVal", v => v + "°");
    bindSlider("cloudScale", "cloudScale", "cloudScaleVal");
    bindSlider("cloudDensity", "cloudDensity", "cloudDensityVal", v => v.toFixed(2));
    bindSlider("evolve", "evolve", "evolveVal", v => v.toFixed(3));
    bindSlider("gradientAngle", "gradientAngle", "gradientAngleVal", v => v + "°");
    bindSlider("colorShift", "colorShift", "colorShiftVal", v => v.toFixed(2));
    bindSlider("saturation", "saturation", "saturationVal");
    bindSlider("ditherScale", "ditherScale", "ditherScaleVal", v => v.toFixed(2));
    bindSlider("contrast", "contrast", "contrastVal");
    bindSlider("greyLevels", "greyLevels", "greyLevelsVal", v => Math.floor(v).toString());

    document.getElementById("useColor").onchange = (e) => {
      settings.useColor = e.target.checked;
    };
    document.getElementById("mouseEnabled").onchange = (e) => {
      settings.mouseEnabled = e.target.checked;
    };
    bindSlider("mouseRadius", "mouseRadius", "mouseRadiusVal", v => Math.floor(v).toString());
    bindSlider("mouseSoftness", "mouseSoftness", "mouseSoftnessVal");
    bindSlider("mouseStrength", "mouseStrength", "mouseStrengthVal");
    bindSlider("mouseEasing", "mouseEasing", "mouseEasingVal", v => v.toFixed(2));

    // Update all UI controls from settings
    const updateUIFromSettings = () => {
      document.getElementById("gamma").value = settings.gamma;
      document.getElementById("gammaVal").textContent = settings.gamma.toFixed(1);
      document.getElementById("speed").value = settings.speed;
      document.getElementById("speedVal").textContent = settings.speed.toFixed(2);
      document.getElementById("direction").value = settings.direction;
      document.getElementById("directionVal").textContent = settings.direction + "°";
      document.getElementById("cloudScale").value = settings.cloudScale;
      document.getElementById("cloudScaleVal").textContent = settings.cloudScale.toFixed(1);
      document.getElementById("cloudDensity").value = settings.cloudDensity;
      document.getElementById("cloudDensityVal").textContent = settings.cloudDensity.toFixed(2);
      document.getElementById("evolve").value = settings.evolve;
      document.getElementById("evolveVal").textContent = settings.evolve.toFixed(3);
      document.getElementById("gradientAngle").value = settings.gradientAngle;
      document.getElementById("gradientAngleVal").textContent = settings.gradientAngle + "°";
      document.getElementById("colorShift").value = settings.colorShift;
      document.getElementById("colorShiftVal").textContent = settings.colorShift.toFixed(2);
      document.getElementById("saturation").value = settings.saturation;
      document.getElementById("saturationVal").textContent = settings.saturation.toFixed(1);
      document.getElementById("useColor").checked = settings.useColor;
      document.getElementById("ditherScale").value = settings.ditherScale;
      document.getElementById("ditherScaleVal").textContent = settings.ditherScale.toFixed(2);
      document.getElementById("contrast").value = settings.contrast;
      document.getElementById("contrastVal").textContent = settings.contrast.toFixed(1);
      document.getElementById("greyLevels").value = settings.greyLevels;
      document.getElementById("greyLevelsVal").textContent = Math.floor(settings.greyLevels).toString();
      document.getElementById("mouseEnabled").checked = settings.mouseEnabled;
      document.getElementById("mouseRadius").value = settings.mouseRadius;
      document.getElementById("mouseRadiusVal").textContent = Math.floor(settings.mouseRadius).toString();
      document.getElementById("mouseSoftness").value = settings.mouseSoftness;
      document.getElementById("mouseSoftnessVal").textContent = settings.mouseSoftness.toFixed(1);
      document.getElementById("mouseStrength").value = settings.mouseStrength;
      document.getElementById("mouseStrengthVal").textContent = settings.mouseStrength.toFixed(1);
      document.getElementById("mouseEasing").value = settings.mouseEasing;
      document.getElementById("mouseEasingVal").textContent = settings.mouseEasing.toFixed(2);
    };

    // Initialize UI from loaded settings
    updateUIFromSettings();
    updateProfileSelect();

    // Profile buttons
    document.getElementById("saveProfile").onclick = (e) => {
      e.preventDefault();
      const nameInput = document.getElementById('profileName');
      const name = nameInput.value.trim();
      if (!name) {
        alert('Please enter a profile name');
        return;
      }
      profiles[name] = { ...settings };
      saveProfiles(profiles);
      updateProfileSelect();
      document.getElementById('profileSelect').value = name;
      nameInput.value = '';
    };

    // Load profile on select change
    document.getElementById("profileSelect").onchange = (e) => {
      const name = e.target.value;
      if (name && profiles[name]) {
        Object.assign(settings, profiles[name]);
        updateUIFromSettings();
      }
    };

    document.getElementById("deleteProfile").onclick = () => {
      const name = document.getElementById('profileSelect').value;
      if (!name || !profiles[name]) {
        alert('Please select a profile to delete');
        return;
      }
      if (confirm(`Delete profile "${name}"?`)) {
        delete profiles[name];
        saveProfiles(profiles);
        updateProfileSelect();
      }
    };

    // Save current settings as defaults
    document.getElementById("saveDefaults").onclick = () => {
      localStorage.setItem('cloudDitherGradientSettings', JSON.stringify(settings));
    };

    // Reset to original defaults
    document.getElementById("resetDefaults").onclick = () => {
      localStorage.removeItem('cloudDitherGradientSettings');
      Object.assign(settings, defaultSettings);
      updateUIFromSettings();
    };

    let panelVisible = true;
    const togglePanel = () => {
      panelVisible = !panelVisible;
      controlsPanel.style.display = panelVisible ? "block" : "none";
    };
    toggleBtn.onclick = togglePanel;

    const profilesPanel = document.getElementById("profilesPanel");
    let profilesPanelVisible = true;
    const toggleProfilesPanel = () => {
      profilesPanelVisible = !profilesPanelVisible;
      profilesPanel.style.display = profilesPanelVisible ? "block" : "none";
    };
    document.getElementById("toggleProfilesPanel").onclick = toggleProfilesPanel;

    document.addEventListener("keydown", e => {
      // Don't trigger shortcuts when typing in input fields
      if (e.target.tagName === 'INPUT') return;
      if (e.key === "h" || e.key === "H") togglePanel();
      if (e.key === "p" || e.key === "P") toggleProfilesPanel();
    });

    // size of canvas
    const imgSize = 512;

    canvas.width = imgSize;
    canvas.height = imgSize;

    // init image data with black pixels
    const image = ctx.createImageData(imgSize, imgSize);
    for (let i = 0; i < image.data.length; i += 4) {
      image.data[i] = 0;
      image.data[i + 1] = 0;
      image.data[i + 2] = 0;
      image.data[i + 3] = 255;
    }

    // size of our height maps
    const mapSize = 1024;

    // Simplex noise implementation for cloud-like patterns
    const perm = new Uint8Array(512);
    const p = [151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];
    for (let i = 0; i < 256; i++) perm[i] = perm[i + 256] = p[i];

    const grad3 = [[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];

    const dot3 = (g, x, y, z) => g[0]*x + g[1]*y + g[2]*z;

    const noise3D = (x, y, z) => {
      const F3 = 1/3, G3 = 1/6;
      const s = (x+y+z)*F3;
      const i = Math.floor(x+s), j = Math.floor(y+s), k = Math.floor(z+s);
      const t = (i+j+k)*G3;
      const X0 = i-t, Y0 = j-t, Z0 = k-t;
      const x0 = x-X0, y0 = y-Y0, z0 = z-Z0;
      let i1,j1,k1,i2,j2,k2;
      if(x0>=y0){if(y0>=z0){i1=1;j1=0;k1=0;i2=1;j2=1;k2=0;}else if(x0>=z0){i1=1;j1=0;k1=0;i2=1;j2=0;k2=1;}else{i1=0;j1=0;k1=1;i2=1;j2=0;k2=1;}}
      else{if(y0<z0){i1=0;j1=0;k1=1;i2=0;j2=1;k2=1;}else if(x0<z0){i1=0;j1=1;k1=0;i2=0;j2=1;k2=1;}else{i1=0;j1=1;k1=0;i2=1;j2=1;k2=0;}}
      const x1=x0-i1+G3,y1=y0-j1+G3,z1=z0-k1+G3;
      const x2=x0-i2+2*G3,y2=y0-j2+2*G3,z2=z0-k2+2*G3;
      const x3=x0-1+3*G3,y3=y0-1+3*G3,z3=z0-1+3*G3;
      const ii=i&255,jj=j&255,kk=k&255;
      const gi0=perm[ii+perm[jj+perm[kk]]]%12;
      const gi1=perm[ii+i1+perm[jj+j1+perm[kk+k1]]]%12;
      const gi2=perm[ii+i2+perm[jj+j2+perm[kk+k2]]]%12;
      const gi3=perm[ii+1+perm[jj+1+perm[kk+1]]]%12;
      let t0=0.6-x0*x0-y0*y0-z0*z0;
      let n0=t0<0?0:(t0*=t0,t0*t0*dot3(grad3[gi0],x0,y0,z0));
      let t1=0.6-x1*x1-y1*y1-z1*z1;
      let n1=t1<0?0:(t1*=t1,t1*t1*dot3(grad3[gi1],x1,y1,z1));
      let t2=0.6-x2*x2-y2*y2-z2*z2;
      let n2=t2<0?0:(t2*=t2,t2*t2*dot3(grad3[gi2],x2,y2,z2));
      let t3=0.6-x3*x3-y3*y3-z3*z3;
      let n3=t3<0?0:(t3*=t3,t3*t3*dot3(grad3[gi3],x3,y3,z3));
      return 32*(n0+n1+n2+n3);
    };

    // Fractal Brownian Motion for cloud-like noise
    const fbm = (x, y, z, octaves = 5) => {
      let value = 0, amplitude = 0.5, frequency = 1, max = 0;
      for (let i = 0; i < octaves; i++) {
        value += amplitude * noise3D(x * frequency, y * frequency, z * frequency);
        max += amplitude;
        amplitude *= 0.5;
        frequency *= 2;
      }
      return value / max;
    };

    // 8x8 Bayer dithering matrix
    const bayer8x8 = [
      [ 0, 32,  8, 40,  2, 34, 10, 42],
      [48, 16, 56, 24, 50, 18, 58, 26],
      [12, 44,  4, 36, 14, 46,  6, 38],
      [60, 28, 52, 20, 62, 30, 54, 22],
      [ 3, 35, 11, 43,  1, 33,  9, 41],
      [51, 19, 59, 27, 49, 17, 57, 25],
      [15, 47,  7, 39, 13, 45,  5, 37],
      [63, 31, 55, 23, 61, 29, 53, 21]
    ];

    const bayerNorm = bayer8x8.map(row => row.map(v => v / 64));

    // Color interpolation with gradient
    const getGradientColor = (u, v, brightness) => {
      const rad = settings.gradientAngle * Math.PI / 180;
      const cx = imgSize / 2, cy = imgSize / 2;
      const dx = v - cx, dy = u - cy;

      // Project onto gradient direction
      const proj = (dx * Math.cos(rad) + dy * Math.sin(rad)) / imgSize + 0.5;
      const t = Math.max(0, Math.min(1, proj));

      // Shift colors over time/setting
      const shift = settings.colorShift;
      const t1 = (t + shift) % 1;
      const t2 = (t + shift + 0.5) % 1;

      // Blend between two gradient pairs based on position
      // Gradient 1: Pink -> Yellow (from your CSS)
      // Gradient 2: Purple -> Cyan
      const c1a = gradientColors[0]; // Pink
      const c1b = gradientColors[1]; // Yellow
      const c2a = gradientColors[2]; // Purple
      const c2b = gradientColors[3]; // Cyan

      // Interpolate within each gradient
      const lerp = (a, b, t) => a + (b - a) * t;

      const g1r = lerp(c1a.r, c1b.r, t1);
      const g1g = lerp(c1a.g, c1b.g, t1);
      const g1b = lerp(c1a.b, c1b.b, t1);

      const g2r = lerp(c2a.r, c2b.r, t2);
      const g2g = lerp(c2a.g, c2b.g, t2);
      const g2b = lerp(c2a.b, c2b.b, t2);

      // Blend the two gradients
      const blendT = (Math.sin(t * Math.PI * 2) + 1) / 2;
      let r = lerp(g1r, g2r, blendT);
      let g = lerp(g1g, g2g, blendT);
      let b = lerp(g1b, g2b, blendT);

      // Apply saturation
      const gray = 0.299 * r + 0.587 * g + 0.114 * b;
      r = gray + (r - gray) * settings.saturation;
      g = gray + (g - gray) * settings.saturation;
      b = gray + (b - gray) * settings.saturation;

      // Apply brightness
      r = r * brightness;
      g = g * brightness;
      b = b * brightness;

      return {
        r: Math.max(0, Math.min(255, Math.round(r))),
        g: Math.max(0, Math.min(255, Math.round(g))),
        b: Math.max(0, Math.min(255, Math.round(b)))
      };
    };

    let offsetX = 0, offsetY = 0, zOffset = 0;
    let lastTime = 0;

    const updateImageData = (t) => {
      const dt = (t - lastTime) / 1000;
      lastTime = t;

      // Calculate drift direction
      const rad = settings.direction * Math.PI / 180;
      const driftSpeed = settings.speed * 0.5;
      offsetX += Math.cos(rad) * driftSpeed * dt;
      offsetY += Math.sin(rad) * driftSpeed * dt;
      zOffset += settings.evolve * dt * 0.3;

      const scale = settings.ditherScale;
      const noiseScale = 0.005 / settings.cloudScale;

      for (let u = 0; u < imgSize; u++) {
        for (let v = 0; v < imgSize; v++) {
          const j = u * imgSize * 4 + v * 4;

          // Cloud noise using FBM with directional drift
          const nx = (v * noiseScale) + offsetX;
          const ny = (u * noiseScale) + offsetY;
          const n = fbm(nx, ny, zOffset, 5);

          // Normalize from [-1,1] to [0,1] and apply density
          // Lower density = more black space between clouds
          const normalized = (n + 1) * 0.5;
          const densityAdjusted = Math.max(0, (normalized - (1 - settings.cloudDensity)) / settings.cloudDensity);

          // Pure black for empty space (no dithering dots)
          if (densityAdjusted === 0) {
            image.data[j] = 0;
            image.data[j + 1] = 0;
            image.data[j + 2] = 0;
            continue;
          }

          const h = densityAdjusted * 255;

          // Apply contrast
          let brightness = h / 255;
          brightness = (brightness - 0.5) * settings.contrast + 0.5;
          brightness = Math.max(0, Math.min(1, brightness));

          // Apply mouse effect - push cloud elevation down (before gamma)
          if (settings.mouseEnabled) {
            const dx = v - mouseX;
            const dy = u - mouseY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const radius = settings.mouseRadius;
            const softness = settings.mouseSoftness;
            const innerRadius = radius * (1 - softness);

            if (dist < radius) {
              let falloff;
              if (dist < innerRadius) {
                falloff = 1;
              } else {
                falloff = 1 - (dist - innerRadius) / (radius - innerRadius);
              }
              // Subtract from elevation, pushing clouds "down" into darkness
              brightness = Math.max(0, brightness - falloff * settings.mouseStrength);
            }
          }

          // Apply gamma
          brightness = Math.pow(brightness, settings.gamma);

          // Get bayer threshold (scaled)
          const bu = Math.floor(u / scale) % 8;
          const bv = Math.floor(v / scale) % 8;
          const threshold = bayerNorm[bu][bv];

          // Multi-level dithering for color gradations
          const levels = settings.greyLevels;
          const levelBrightness = brightness * (levels - 1);
          const lowLevel = Math.floor(levelBrightness);
          const highLevel = Math.min(lowLevel + 1, levels - 1);
          const remainder = levelBrightness - lowLevel;

          const chosenLevel = remainder > threshold ? highLevel : lowLevel;
          const finalBrightness = chosenLevel / (levels - 1);

          if (settings.useColor) {
            // Get gradient color at this position
            const color = getGradientColor(u, v, finalBrightness);
            image.data[j] = color.r;
            image.data[j + 1] = color.g;
            image.data[j + 2] = color.b;
          } else {
            // Greyscale
            const grey = Math.round(finalBrightness * 255);
            image.data[j] = grey;
            image.data[j + 1] = grey;
            image.data[j + 2] = grey;
          }
        }
      }
    };

    const tick = t => {
      updateMousePosition();
      updateImageData(t);
      ctx.putImageData(image, 0, 0);
      requestAnimationFrame(tick);
    };

    requestAnimationFrame(tick);
  </script>
</body>
